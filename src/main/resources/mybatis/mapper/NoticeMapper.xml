<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.odm.oa.mapper.NoticeMapper">
  <resultMap id="BaseResultMap" type="com.odm.oa.entity.Notice">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 09 19:05:23 CST 2018.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="review_flg" jdbcType="BIT" property="reviewFlg" />
    <result column="del_flg" jdbcType="BIT" property="delFlg" />
    <result column="version" jdbcType="INTEGER" property="version" />
    <result column="create_id" jdbcType="VARCHAR" property="createId" />
    <result column="create_time" jdbcType="DATE" property="createTime" />
    <result column="update_id" jdbcType="VARCHAR" property="updateId" />
    <result column="update_time" jdbcType="DATE" property="updateTime" />
    <result column="type" jdbcType="BIGINT" property="type" />
    <result column="review_id_two" jdbcType="BIGINT" property="reviewIdTwo" />
    <result column="review_id_one" jdbcType="BIGINT" property="reviewIdOne" />
    <result column="status" jdbcType="BIT" property="status" />
    <result column="review_one_status" jdbcType="BIT" property="reviewOneStatus" />
    <result column="review_two_status" jdbcType="BIT" property="reviewTwoStatus" />
    <result column="content" jdbcType="LONGVARCHAR" property="content" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 09 19:05:23 CST 2018.
    -->
    delete from notice
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.odm.oa.entity.Notice" keyColumn="id" keyProperty="id" useGeneratedKeys="true">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 09 19:05:23 CST 2018.
    -->
    insert into notice (id, title, review_flg, 
      del_flg, version, create_id, 
      create_time, update_id, update_time, 
      type, review_id_two, review_id_one,
      status, review_one_status,review_two_status,content)
    values (#{id,jdbcType=BIGINT}, #{title,jdbcType=VARCHAR}, #{reviewFlg,jdbcType=BIT}, 
      #{delFlg,jdbcType=BIT}, #{version,jdbcType=INTEGER}, #{createId,jdbcType=VARCHAR}, 
      #{createTime,jdbcType=DATE}, #{updateId,jdbcType=VARCHAR}, #{updateTime,jdbcType=DATE}, 
      #{type,jdbcType=BIGINT}, #{reviewIdTwo,jdbcType=BIGINT}, #{reviewIdOne,jdbcType=BIGINT},
      #{status,jdbcType=BIT}, #{reviewOneStatus,jdbcType=BIT},#{reviewTwoStatus,jdbcType=BIT},#{content,jdbcType=LONGVARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.odm.oa.entity.Notice">
    <!--不更新创建人-->
    update notice
    set title = #{title,jdbcType=VARCHAR},
      review_flg = #{reviewFlg,jdbcType=BIT},
      del_flg = #{delFlg,jdbcType=BIT},
      version = #{version,jdbcType=INTEGER},
      update_id = #{updateId,jdbcType=VARCHAR},
      create_id = #{createId,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=DATE},
      update_time = #{updateTime,jdbcType=DATE},
      type = #{type,jdbcType=BIGINT},
      review_id_two = #{reviewIdTwo,jdbcType=BIGINT},
      review_id_one = #{reviewIdOne,jdbcType=BIGINT},
      status = #{status,jdbcType=BIT},
      review_one_status = #{reviewOneStatus,jdbcType=BIT},
      review_two_status = #{reviewTwoStatus,jdbcType=BIT},
      content = #{content,jdbcType=LONGVARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 09 19:05:23 CST 2018.
    -->
    select id, title, review_flg, del_flg, version, create_id, create_time, update_id, 
    update_time, type, review_id_two, review_id_one, status, review_one_status,review_two_status,content
    from notice
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="pagination" parameterType="com.odm.oa.model.request.NoticePagination" resultType="com.odm.oa.entity.ex.NoticeEx">
    select n.title as title,n.create_time as createTime,s.name as author,n.id as id,n.review_flg as reviewFlg,nt.name as typeName,
    n.review_id_one as reviewIdOne,n.review_id_two as reviewIdTwo,n.review_one_status as reviewOneStatus,n.review_two_status as reviewTwoStatus
    from NOTICE n
    left join STAFF s on s.staff_no = n.create_id
    left join NOTICE_TYPE nt on n.type=nt.id
    <include refid="paginationCondition"/>
  </select>
  <sql id="paginationCondition">
    <where>
      <if test="title != null and title != ''">
        and n.title like concat('%',
        concat(#{title},'%'))
      </if>
      <if test="author != null and author != ''">
        AND s.name =#{author}
      </if>
      <if test="startTime != null ">
        AND date_format(n.create_time,'%Y-%m-%d %H:%i') &gt;= #{startTime}
      </if>
      <if test="endTime != null ">
        AND date_format(n.create_time,'%Y-%m-%d %H:%i') &lt;= #{endTime}
      </if>
      <!--<if test="date != null and date != ''">

      </if>-->
      and n.del_flg='0' and (n.review_id_one=#{reviewId} or n.review_id_two=#{reviewId}) and n.status=1 order by n.create_time desc
    </where>
  </sql>
  <select id="selectAll" resultMap="BaseResultMap">
    select id, title, review_flg, del_flg, version, create_id, create_time, update_id,
    update_time, type, review_id_two, review_id_one, status, review_one_status,review_two_status,content
    from notice where del_flg=0
  </select>
  <select id="lookOneNotice" parameterType="java.lang.Long" resultType="com.odm.oa.entity.ex.NoticeEx">
    <!--一条公告详情-->
    select n.title as title,n.create_time as createTime,s.name as author,n.id as id,n.content as content,
    n.status as status,nt.name as typeName,n.review_flg as reviewFlg,n.create_id as staffNo,s1.name as reviewOneName,
    s2.name as reviewTwoName,n.review_one_status as reviewOneStatus,n.review_two_status as reviewTwoStatus
    from NOTICE n
    left join STAFF s on s.staff_no = n.create_id
    left join STAFF s1 on s1.id=n.review_id_one
    left join STAFF s2 on s2.id=n.review_id_two
    left join NOTICE_TYPE nt on n.type=nt.id
    where n.del_flg='0' and n.id=#{id}
  </select>
  <select id="getPersonalNotice" parameterType="java.lang.String" resultType="com.odm.oa.entity.ex.NoticeEx">
    <!--收到的公告-->
    select n.title as title,n.create_time as createTime,s.name as author,n.id as id,n.content as content
    from NOTICE n
    left join STAFF s on s.staff_no = n.create_id and s.del_flg='0'
    inner join Notice_Record nr on n.id=nr.notice_id and nr.user_id=(select id from STAFF where staff_no=#{no}) and nr.del_flg='0'
    where n.del_flg='0' and n.review_flg="1" and n.status=3
  </select>
  <select id="getSavedNotice" parameterType="java.lang.String" resultType="com.odm.oa.entity.ex.NoticeEx">
    <!--草稿公告-->
    select n.title as title,n.create_time as createTime,s.name as author,n.id as id,n.content as content
    from NOTICE n
    left join STAFF s on s.staff_no = n.create_id and s.del_flg='0'
    where n.del_flg='0' and n.status=0 and n.create_id=#{no}
  </select>
  <select id="getToReviewNotice" parameterType="java.lang.String" resultType="com.odm.oa.entity.ex.NoticeEx">
    <!--待审核公告-->
    select n.title as title,n.create_time as createTime,s.name as author,n.id as id,n.content as content
    from NOTICE n
    left join STAFF s on s.staff_no = n.create_id and s.del_flg='0'
    where n.del_flg='0' and n.status=1 and n.create_id=#{no}
  </select>
  <select id="getReleasedNotice" parameterType="java.lang.String" resultType="com.odm.oa.entity.ex.NoticeEx">
  <!--已发布公告-->
  select n.title as title,n.create_time as createTime,s.name as author,n.id as id,n.content as content
  from NOTICE n
  left join STAFF s on s.staff_no = n.create_id and s.del_flg='0'
  where n.del_flg='0' and n.status=3 and n.create_id=#{no}
</select>
  <select id="getEditData" parameterType="java.lang.Long" resultType="com.odm.oa.model.request.SubmitNoticeRequest">
    <!--获取公告信息，编辑用-->
    select n.id as id,n.title as title,n.content as content,
    n.type as type,n.review_id_two as reviewIdTwo,review_id_one as reviewIdOne, n.status as status,n.review_one_status as reviewOneStatus,
    n.review_two_status as reviewTwoStatus
    from NOTICE n where n.id=#{id}
  </select>
  <select id="getEditDataStaff" parameterType="java.lang.Long" resultType="java.lang.Long">
    select user_id from NOTICE_RECORD where notice_id=#{id}
  </select>
  <select id="getPieChartCount" resultType="java.lang.Long">
    select count(*) from NOTICE where create_id=#{0} and type=#{1} and review_flg=1
  </select>
  <select id="deleteById" parameterType="java.lang.Long">
    update NOTICE set del_flg = '1' where id=#{id}
  </select>
</mapper>